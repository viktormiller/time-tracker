---
phase: 01-authentication-a-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/scripts/generate-secrets.sh
  - backend/src/plugins/auth.ts
  - backend/src/plugins/session.ts
  - backend/src/plugins/security.ts
autonomous: true

must_haves:
  truths:
    - "Backend has JWT signing capability"
    - "Secrets are generated securely (64+ chars)"
    - "Sessions use HttpOnly cookies"
    - "Security headers are applied"
    - "Rate limiting prevents brute force"
  artifacts:
    - path: "backend/package.json"
      provides: "Auth dependencies installed"
      contains: "@fastify/jwt"
    - path: "backend/scripts/generate-secrets.sh"
      provides: "Secure secret generation"
      min_lines: 30
    - path: "backend/src/plugins/auth.ts"
      provides: "JWT plugin configuration"
      exports: ["default"]
    - path: "backend/src/plugins/session.ts"
      provides: "Secure session plugin"
      exports: ["default"]
    - path: "backend/src/plugins/security.ts"
      provides: "Security headers and rate limiting"
      exports: ["default"]
  key_links:
    - from: "backend/src/server.ts"
      to: "backend/src/plugins/*.ts"
      via: "fastify.register() calls"
      pattern: "fastify\\.register.*plugins"
---

<objective>
Establish backend authentication infrastructure with JWT, secure sessions, and security hardening.

Purpose: Provides the foundational authentication capabilities (JWT signing, session management, security headers) that all subsequent auth features depend on.

Output: Backend with installed auth dependencies, secret generation tooling, and registered Fastify auth plugins.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-a-security/01-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md
@backend/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Install authentication dependencies</name>
  <files>backend/package.json</files>
  <action>
Install Fastify auth ecosystem and supporting libraries:

```bash
cd backend
npm install @fastify/jwt @fastify/secure-session @fastify/cookie bcrypt @fastify/helmet @fastify/rate-limit
npm install --save-dev @types/bcrypt
```

Use exact versions from RESEARCH.md:
- @fastify/jwt v9.x (for Fastify 5) OR v8.x (for Fastify 4 - check current version)
- @fastify/secure-session (latest)
- @fastify/cookie (latest)
- bcrypt ^5.1.x
- @fastify/helmet (latest)
- @fastify/rate-limit (latest)

Verify Fastify version first with `grep "fastify" backend/package.json` to determine correct @fastify/jwt version (v8 for Fastify 4, v9 for Fastify 5).
  </action>
  <verify>
Run `grep -E "(fastify/jwt|bcrypt|secure-session|helmet|rate-limit)" backend/package.json` to confirm all packages present in dependencies.
  </verify>
  <done>
All auth dependencies appear in backend/package.json dependencies section with correct versions for current Fastify version.
  </done>
</task>

<task type="auto">
  <name>Create secure secret generation script</name>
  <files>backend/scripts/generate-secrets.sh</files>
  <action>
Create bash script that generates cryptographically secure secrets for JWT, session, and admin password.

Script must:
1. Create `backend/secrets/` directory
2. Generate JWT secret (64 bytes hex) → `secrets/jwt_secret.txt`
3. Generate session secret (32 bytes hex) → `secrets/session_secret.txt`
4. Prompt for admin password, hash with bcrypt (12 rounds) → `secrets/admin_password_hash.txt`
5. Set file permissions to 600 (owner read/write only)
6. Print instructions to add `secrets/` to .gitignore

Use pattern from RESEARCH.md "Generate Secrets Script" section (lines 822-846).

DO NOT commit secrets to git. Script output files should remain local only.
  </action>
  <verify>
Run:
```bash
chmod +x backend/scripts/generate-secrets.sh
cd backend && echo "test_password" | ./scripts/generate-secrets.sh
ls -la backend/secrets/
```

Confirm:
- secrets/jwt_secret.txt exists with 128+ character hex string
- secrets/session_secret.txt exists with 64+ character hex string
- secrets/admin_password_hash.txt exists with bcrypt hash (starts with $2b$)
- All files have 600 permissions
  </verify>
  <done>
Script successfully generates all three secret files with correct format and secure permissions. Secrets directory created with appropriate security warnings.
  </done>
</task>

<task type="auto">
  <name>Create Fastify auth plugins</name>
  <files>
backend/src/plugins/auth.ts
backend/src/plugins/session.ts
backend/src/plugins/security.ts
  </files>
  <action>
Create three Fastify plugins following patterns from RESEARCH.md:

**1. backend/src/plugins/auth.ts**
- Register @fastify/jwt with secret from loadSecret('jwt_secret')
- Configure: expiresIn '15m', cookie support for refreshToken
- Decorate fastify instance with `authenticate` function (calls request.jwtVerify)
- Use fastify-plugin wrapper for proper encapsulation
- Pattern from RESEARCH.md lines 83-104

**2. backend/src/plugins/session.ts**
- Register @fastify/secure-session with secret from loadSecret('session_secret')
- Configure HttpOnly cookies: path '/', sameSite 'strict', secure in production
- Session regeneration support (will be used in login route)
- Pattern from RESEARCH.md lines 230-244

**3. backend/src/plugins/security.ts**
- Register @fastify/helmet (security headers)
- Register @fastify/rate-limit: max 5 requests per 15min window
- Allowlist health checks from rate limiting
- Pattern from RESEARCH.md lines 598-610

**Shared utility: loadSecret() function**
Create in auth.ts and export:
- Reads from `/run/secrets/{name}` (Docker Secrets path)
- Falls back to `process.env[NAME_UPPERCASE]` for development
- Throws error if secret not found
- Pattern from RESEARCH.md lines 743-752

DO NOT hardcode secrets. Always use loadSecret() or environment variables.
DO NOT use weak secrets (must validate length >= 32 chars).
  </action>
  <verify>
Run:
```bash
cd backend
npx tsc --noEmit
grep -l "loadSecret" src/plugins/auth.ts
grep -l "@fastify/jwt" src/plugins/auth.ts
grep -l "@fastify/secure-session" src/plugins/session.ts
grep -l "@fastify/helmet" src/plugins/security.ts
```

All files should exist, compile without errors, and contain expected imports.
  </verify>
  <done>
Three plugin files created with:
- auth.ts exports JWT plugin and loadSecret utility
- session.ts exports secure session plugin
- security.ts exports helmet + rate-limit plugin
All plugins use fastify-plugin pattern and follow RESEARCH.md architecture
  </done>
</task>

</tasks>

<verification>
1. Run `npm list @fastify/jwt @fastify/secure-session bcrypt` from backend/ - all packages installed
2. Run `backend/scripts/generate-secrets.sh` - generates three secret files
3. Inspect `backend/src/plugins/*.ts` - three plugins exist with correct imports
4. Run `npx tsc --noEmit` from backend/ - no TypeScript errors
</verification>

<success_criteria>
- All auth dependencies installed and appear in package.json
- Secret generation script exists and produces valid secrets
- Three auth plugins created (auth, session, security)
- loadSecret() utility exists for Docker Secrets + env var fallback
- No secrets hardcoded in source files
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-a-security/01-01-SUMMARY.md`
</output>
