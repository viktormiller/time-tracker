---
phase: 01-authentication-a-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - backend/src/server.ts
  - backend/src/routes/auth.routes.ts
autonomous: true

must_haves:
  truths:
    - "User can POST to /api/auth/login with credentials"
    - "Valid credentials return access token + set refresh token cookie"
    - "Invalid credentials return 401"
    - "User can POST to /api/auth/refresh to get new access token"
    - "User can POST to /api/auth/logout to clear session"
  artifacts:
    - path: "backend/src/routes/auth.routes.ts"
      provides: "Login, logout, refresh endpoints"
      min_lines: 100
      exports: ["default"]
    - path: "backend/src/server.ts"
      provides: "Auth plugin registration and route mounting"
      contains: "register.*auth.routes"
  key_links:
    - from: "backend/src/routes/auth.routes.ts"
      to: "bcrypt.compare()"
      via: "password verification"
      pattern: "bcrypt\\.compare"
    - from: "backend/src/routes/auth.routes.ts"
      to: "fastify.jwt.sign()"
      via: "token generation"
      pattern: "jwt\\.sign"
    - from: "backend/src/routes/auth.routes.ts"
      to: "reply.setCookie()"
      via: "refresh token storage"
      pattern: "setCookie.*refreshToken"
---

<objective>
Implement authentication routes (login, logout, refresh) and register auth plugins in server.

Purpose: Enables user authentication flow - credentials validation, token issuance, session management, and logout.

Output: Working auth endpoints that issue JWT tokens and manage sessions via HttpOnly cookies.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-authentication-a-security/01-RESEARCH.md
@.planning/phases/01-authentication-a-security/01-01-SUMMARY.md
@backend/src/server.ts
@backend/src/plugins/auth.ts
@backend/src/plugins/session.ts
@backend/src/plugins/security.ts
</context>

<tasks>

<task type="auto">
  <name>Register auth plugins in server</name>
  <files>backend/src/server.ts</files>
  <action>
Update server.ts to register auth plugins before route definitions:

1. Import plugins at top of file:
```typescript
import authPlugin from './plugins/auth';
import sessionPlugin from './plugins/session';
import securityPlugin from './plugins/security';
```

2. Register plugins AFTER existing cors/multipart plugins, BEFORE routes:
```typescript
// Security plugins (from RESEARCH.md lines 598-634)
app.register(securityPlugin);
app.register(authPlugin);
app.register(sessionPlugin);
```

Order matters:
- Security (helmet, rate-limit) first
- Auth (JWT) second
- Session third
- Routes last

Update CORS configuration to be more restrictive:
```typescript
app.register(cors, {
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true // Required for cookies
});
```

DO NOT add global authentication hook (would protect login route).
DO NOT change existing route definitions yet (Plan 03 handles that).
  </action>
  <verify>
Run:
```bash
cd backend
npx tsc --noEmit
grep "register.*authPlugin" src/server.ts
grep "register.*sessionPlugin" src/server.ts
grep "register.*securityPlugin" src/server.ts
grep "credentials: true" src/server.ts
```

All plugins should be registered and CORS updated.
  </verify>
  <done>
server.ts imports and registers all three auth plugins in correct order. CORS configured with credentials: true. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Create authentication routes</name>
  <files>backend/src/routes/auth.routes.ts</files>
  <action>
Create auth.routes.ts with three endpoints following RESEARCH.md patterns:

**POST /api/auth/login** (lines 646-683 in RESEARCH.md):
- Accept {username, password} in request body
- Validate username matches process.env.ADMIN_USER (default: 'admin')
- Load admin password hash using loadSecret('admin_password_hash')
- Verify password with bcrypt.compare()
- Return 401 if invalid credentials
- On success:
  - Call request.session.delete() to prevent session fixation (CRITICAL - Pitfall 1)
  - Set request.session userId=1, authenticated=true
  - Generate access token: fastify.jwt.sign({userId: 1, role: 'admin'}, {expiresIn: '15m'})
  - Generate refresh token: fastify.jwt.sign({userId: 1, type: 'refresh'}, {expiresIn: '30d'})
  - Store refresh token in HttpOnly cookie (sameSite: 'strict', secure: production only)
  - Return {accessToken, expiresIn: 900}

**POST /api/auth/refresh** (lines 685-715 in RESEARCH.md):
- Read refreshToken from request.cookies.refreshToken
- Return 401 if missing
- Verify token with fastify.jwt.verify()
- Validate decoded.type === 'refresh'
- Generate NEW access token and NEW refresh token (rotation - Pitfall 3)
- Update refresh token cookie
- Return {accessToken, expiresIn: 900}

**POST /api/auth/logout** (lines 719-725 in RESEARCH.md):
- Use preHandler: [fastify.authenticate] (requires valid access token)
- Call request.session.delete()
- Call reply.clearCookie('refreshToken')
- Return {message: 'Logged out'}

Export as default async function(fastify: FastifyInstance).

Import loadSecret from plugins/auth.ts.
Import bcrypt.

CRITICAL: Session regeneration (request.session.delete() before setting new session) prevents session fixation attacks (CVE-2023-29019).
  </action>
  <verify>
Run:
```bash
cd backend
npx tsc --noEmit
grep "POST.*login" src/routes/auth.routes.ts
grep "POST.*refresh" src/routes/auth.routes.ts
grep "POST.*logout" src/routes/auth.routes.ts
grep "session.delete()" src/routes/auth.routes.ts
grep "bcrypt.compare" src/routes/auth.routes.ts
```

All three routes defined with session regeneration and bcrypt verification.
  </verify>
  <done>
auth.routes.ts created with login, refresh, logout endpoints. Session fixation prevention implemented. Refresh token rotation enabled. All routes follow RESEARCH.md security patterns.
  </done>
</task>

<task type="auto">
  <name>Mount auth routes in server</name>
  <files>backend/src/server.ts</files>
  <action>
Update server.ts to register auth routes:

1. Import auth routes at top:
```typescript
import authRoutes from './routes/auth.routes';
```

2. Register auth routes BEFORE existing API routes (so they remain PUBLIC):
```typescript
// Auth routes (public - no authentication required)
app.register(authRoutes);

// Existing routes remain below (will be protected in Plan 03)
app.get('/api/stats', async (request, reply) => { ... });
```

Auth routes must be registered WITHOUT preHandler authentication (they ARE the authentication).

DO NOT wrap auth routes in authenticated plugin (Pitfall 4).
DO NOT add preHandler to login/refresh routes.
  </action>
  <verify>
Run:
```bash
cd backend
npm run dev &
sleep 3
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"invalid","password":"invalid"}' \
  -w "\nHTTP Status: %{http_code}\n"
pkill -f "node.*server"
```

Should return HTTP 401 (route is registered and returns Unauthorized for invalid creds).
  </verify>
  <done>
Auth routes registered in server.ts. Login endpoint reachable and returns 401 for invalid credentials. Server starts without errors.
  </done>
</task>

</tasks>

<verification>
1. Start backend: `cd backend && npm run dev`
2. Test login with invalid creds: Should return 401
3. Check server logs: No errors on startup
4. Verify plugin registration order: security → auth → session → routes
</verification>

<success_criteria>
- All three auth plugins registered in server.ts
- auth.routes.ts created with login, refresh, logout endpoints
- Login endpoint validates credentials and issues tokens
- Refresh endpoint rotates tokens
- Logout endpoint clears session and cookies
- Session fixation prevention implemented (session.delete() on login)
- All routes accessible via /api/auth/* paths
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-a-security/01-02-SUMMARY.md`
</output>
