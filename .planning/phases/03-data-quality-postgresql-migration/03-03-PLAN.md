---
phase: 03-data-quality-postgresql-migration
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - frontend/src/components/TimezoneSelector.tsx
  - frontend/src/components/RelativeTimestamp.tsx
  - frontend/src/components/ProjectCell.tsx
  - frontend/src/App.tsx
  - frontend/src/lib/timezone.ts
  - frontend/package.json
autonomous: true

must_haves:
  truths:
    - "User can select timezone preference from dropdown"
    - "Timezone preference defaults to browser timezone on first load"
    - "Recent timestamps display as relative time (e.g., '2 hours ago')"
    - "Timestamps older than 24 hours display as absolute date/time"
    - "Jira issue keys are clickable and open in new tab"
  artifacts:
    - path: "frontend/src/components/TimezoneSelector.tsx"
      provides: "Timezone picker component with browser auto-detection"
      min_lines: 20
    - path: "frontend/src/components/RelativeTimestamp.tsx"
      provides: "Relative/absolute timestamp display component"
      min_lines: 25
    - path: "frontend/src/components/ProjectCell.tsx"
      provides: "Project display with clickable Jira links"
      min_lines: 15
    - path: "frontend/src/lib/timezone.ts"
      provides: "Timezone utility functions and persistence"
      exports: ["getTimezone", "setTimezone"]
  key_links:
    - from: "frontend/src/components/ProjectCell.tsx"
      to: "/api/config/jira"
      via: "baseUrl from jira config"
      pattern: "jiraBaseUrl.*browse"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/TimezoneSelector.tsx"
      via: "component import and render"
      pattern: "TimezoneSelector"
---

<objective>
Add frontend components for timezone preference selection, relative timestamp display, and clickable Jira issue links. Integrate these into the dashboard.

Purpose: Improve user experience with configurable timezone display and quick access to Jira issues directly from the dashboard.
Output: Timezone selector, relative timestamp component, clickable project links, integrated into App.tsx
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-quality-postgresql-migration/03-CONTEXT.md
@.planning/phases/03-data-quality-postgresql-migration/03-RESEARCH.md

@frontend/src/App.tsx
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Timezone Dependencies and Create Utilities</name>
  <files>frontend/package.json, frontend/src/lib/timezone.ts</files>
  <action>
Install react-timezone-select for the timezone picker:
```bash
cd frontend && npm install react-timezone-select
```

Create timezone utility module at frontend/src/lib/timezone.ts:

```typescript
// Timezone preference utilities
// Uses localStorage for persistence, browser timezone as default

const TIMEZONE_KEY = 'user_timezone_preference';

/**
 * Get the user's timezone preference.
 * Returns stored preference or browser's detected timezone.
 */
export function getTimezone(): string {
  if (typeof window === 'undefined') {
    return 'UTC';
  }

  const stored = localStorage.getItem(TIMEZONE_KEY);
  if (stored) {
    return stored;
  }

  // Auto-detect browser timezone
  return Intl.DateTimeFormat().resolvedOptions().timeZone;
}

/**
 * Set the user's timezone preference.
 * Persists to localStorage.
 */
export function setTimezone(timezone: string): void {
  localStorage.setItem(TIMEZONE_KEY, timezone);
}

/**
 * Clear timezone preference (reverts to browser detection).
 */
export function clearTimezone(): void {
  localStorage.removeItem(TIMEZONE_KEY);
}

/**
 * Get the browser's detected timezone (ignoring preference).
 */
export function getBrowserTimezone(): string {
  if (typeof window === 'undefined') {
    return 'UTC';
  }
  return Intl.DateTimeFormat().resolvedOptions().timeZone;
}
```

This provides:
- Persistence via localStorage
- Browser timezone auto-detection as default
- Clear API for components to use
  </action>
  <verify>
Check frontend/package.json includes react-timezone-select dependency.
Check frontend/src/lib/timezone.ts exists with getTimezone and setTimezone exports.
  </verify>
  <done>react-timezone-select installed, timezone.ts utility module created with localStorage persistence</done>
</task>

<task type="auto">
  <name>Task 2: Create Timezone Selector and Relative Timestamp Components</name>
  <files>frontend/src/components/TimezoneSelector.tsx, frontend/src/components/RelativeTimestamp.tsx</files>
  <action>
Create TimezoneSelector component at frontend/src/components/TimezoneSelector.tsx:

```typescript
import React from 'react';
import TimezoneSelect from 'react-timezone-select';

interface Props {
  value: string;
  onChange: (timezone: string) => void;
}

export function TimezoneSelector({ value, onChange }: Props) {
  return (
    <div className="w-64">
      <TimezoneSelect
        value={value}
        onChange={(tz) => onChange(tz.value)}
        classNames={{
          control: () => 'border border-gray-300 rounded-lg shadow-sm text-sm',
          menu: () => 'bg-white border border-gray-200 rounded-lg shadow-lg mt-1',
          option: ({ isFocused, isSelected }) =>
            `px-3 py-2 cursor-pointer ${
              isSelected
                ? 'bg-indigo-600 text-white'
                : isFocused
                ? 'bg-gray-100'
                : 'bg-white text-gray-700'
            }`,
        }}
      />
    </div>
  );
}

export default TimezoneSelector;
```

Create RelativeTimestamp component at frontend/src/components/RelativeTimestamp.tsx:

```typescript
import React, { useState, useEffect } from 'react';
import { formatDistanceToNow, format, isAfter, subDays, parseISO } from 'date-fns';
import { de } from 'date-fns/locale';

interface Props {
  date: string | Date;
  className?: string;
}

/**
 * Displays timestamps relative for recent entries, absolute for older ones.
 * - Less than 24 hours: "2 hours ago", "vor 30 Minuten"
 * - More than 24 hours: "20. Jan, 14:30"
 */
export function RelativeTimestamp({ date, className = '' }: Props) {
  const [displayTime, setDisplayTime] = useState('');

  useEffect(() => {
    function updateDisplay() {
      const dateObj = typeof date === 'string' ? parseISO(date) : date;
      const now = new Date();
      const oneDayAgo = subDays(now, 1);

      if (isAfter(dateObj, oneDayAgo)) {
        // Recent: relative time
        setDisplayTime(formatDistanceToNow(dateObj, { addSuffix: true, locale: de }));
      } else {
        // Older: absolute time
        setDisplayTime(format(dateObj, 'dd. MMM, HH:mm', { locale: de }));
      }
    }

    updateDisplay();

    // Update every minute for recent timestamps
    const interval = setInterval(updateDisplay, 60000);
    return () => clearInterval(interval);
  }, [date]);

  const dateObj = typeof date === 'string' ? parseISO(date) : date;

  return (
    <time dateTime={dateObj.toISOString()} className={className} title={format(dateObj, 'PPpp', { locale: de })}>
      {displayTime}
    </time>
  );
}

export default RelativeTimestamp;
```

These components:
- TimezoneSelector wraps react-timezone-select with Tailwind styling
- RelativeTimestamp shows "2 hours ago" for recent, absolute date for older
- Both use German locale to match existing UI
  </action>
  <verify>
Check frontend/src/components/TimezoneSelector.tsx exists with export.
Check frontend/src/components/RelativeTimestamp.tsx exists with export.
Run `cd frontend && npm run build` - should compile without errors.
  </verify>
  <done>TimezoneSelector and RelativeTimestamp components created with Tailwind styling and German locale</done>
</task>

<task type="auto">
  <name>Task 3: Create Clickable Project Cell and Integrate Components</name>
  <files>frontend/src/components/ProjectCell.tsx, frontend/src/App.tsx</files>
  <action>
Create ProjectCell component at frontend/src/components/ProjectCell.tsx:

```typescript
import React from 'react';
import { ExternalLink } from 'lucide-react';

interface Props {
  project: string;
  source: string;
  jiraBaseUrl: string | null;
}

// Regex to detect Jira issue key pattern (e.g., ABC-123, PROJ-1)
const JIRA_KEY_REGEX = /^([A-Z][A-Z0-9]+-\d+)/;

/**
 * Displays project name with clickable Jira link for Tempo entries.
 * Format from backend: "ABC-27 - Project Name" or just "ABC-27"
 */
export function ProjectCell({ project, source, jiraBaseUrl }: Props) {
  // Only process Tempo entries for Jira links
  if (source !== 'TEMPO' || !jiraBaseUrl || !project) {
    return <span className="font-medium text-gray-800">{project || '-'}</span>;
  }

  // Extract issue key from project string
  const match = project.match(JIRA_KEY_REGEX);
  if (!match) {
    return <span className="font-medium text-gray-800">{project}</span>;
  }

  const issueKey = match[1];
  const issueUrl = `${jiraBaseUrl}/browse/${issueKey}`;

  // Display: clickable key + remaining project name
  const remainingText = project.slice(issueKey.length).replace(/^\s*-\s*/, '');

  return (
    <span className="font-medium">
      <a
        href={issueUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="text-blue-600 hover:text-blue-800 hover:underline inline-flex items-center gap-1"
        title={`Open ${issueKey} in Jira`}
      >
        {issueKey}
        <ExternalLink size={12} className="opacity-50" />
      </a>
      {remainingText && <span className="text-gray-600"> - {remainingText}</span>}
    </span>
  );
}

export default ProjectCell;
```

Update App.tsx to integrate the new components:

1. Add imports at top:
```typescript
import { TimezoneSelector } from './components/TimezoneSelector';
import { RelativeTimestamp } from './components/RelativeTimestamp';
import { ProjectCell } from './components/ProjectCell';
import { getTimezone, setTimezone } from './lib/timezone';
```

2. Add state for timezone and Jira config in AppContent:
```typescript
const [timezone, setTimezoneState] = useState(getTimezone());
const [jiraBaseUrl, setJiraBaseUrl] = useState<string | null>(null);

// Fetch Jira config on mount
useEffect(() => {
  axios.get(`${API_URL}/config/jira`)
    .then(res => setJiraBaseUrl(res.data.baseUrl))
    .catch(() => setJiraBaseUrl(null));
}, []);

// Handle timezone change
const handleTimezoneChange = (tz: string) => {
  setTimezoneState(tz);
  setTimezone(tz);
};
```

3. Add timezone selector to header (near logout button):
```tsx
<div className="flex items-center gap-2 mr-4">
  <span className="text-sm text-gray-500">Timezone:</span>
  <TimezoneSelector value={timezone} onChange={handleTimezoneChange} />
</div>
```

4. Replace project column in table to use ProjectCell:
```tsx
<td className="px-6 py-3">
  <ProjectCell
    project={entry.project}
    source={entry.source}
    jiraBaseUrl={jiraBaseUrl}
  />
</td>
```

5. Optionally add RelativeTimestamp for createdAt if displayed:
```tsx
<td className="px-6 py-3 text-gray-500">
  <RelativeTimestamp date={entry.createdAt} />
</td>
```

Note: Keep existing date formatting for the main date column (users expect consistent date display), but add tooltip with relative time if desired.
  </action>
  <verify>
Check frontend/src/components/ProjectCell.tsx exists.
Check App.tsx imports TimezoneSelector, ProjectCell.
Run `cd frontend && npm run build` - should compile without TypeScript errors.
Run `cd frontend && npm run dev` - UI should load with timezone selector in header.
  </verify>
  <done>ProjectCell with clickable Jira links created, TimezoneSelector integrated into header, all components connected in App.tsx</done>
</task>

</tasks>

<verification>
1. `cd frontend && npm run build` - Compiles without errors
2. `cd frontend && npm run dev` - UI loads
3. Timezone selector visible in header, defaults to browser timezone
4. Selecting different timezone persists across page reload
5. Tempo entries with issue keys show clickable links
6. Clicking link opens Jira in new tab (if JIRA_BASE_URL configured)
</verification>

<success_criteria>
- Timezone selector component in header with browser default
- Timezone preference persists in localStorage
- RelativeTimestamp shows relative time for <24h entries
- ProjectCell makes Jira issue keys clickable for Tempo entries
- All components integrate cleanly with existing UI style
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-quality-postgresql-migration/03-03-SUMMARY.md`
</output>
