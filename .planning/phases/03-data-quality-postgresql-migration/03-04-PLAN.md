---
phase: 03-data-quality-postgresql-migration
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Data migration from SQLite to PostgreSQL completes successfully"
    - "All entry counts match pre/post migration"
    - "DateTime fields store with timezone information (TIMESTAMPTZ)"
    - "Concurrent sync operations handle collisions correctly"
    - "Issue keys display correctly in dashboard"
    - "Timezone selector persists user preference"
  artifacts: []
  key_links:
    - from: "backend/scripts/validate-migration.ts"
      to: "PostgreSQL database"
      via: "Prisma client"
      pattern: "VALIDATION PASSED"
---

<objective>
Verify end-to-end functionality of Phase 3 deliverables: database migration, timezone-aware timestamps, collision handling, and frontend display enhancements.

Purpose: Confirm all data quality improvements work correctly before marking phase complete.
Output: Verified working system with migration complete and all features functional
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-quality-postgresql-migration/03-CONTEXT.md

# Prior plan summaries needed for verification context
@.planning/phases/03-data-quality-postgresql-migration/03-01-SUMMARY.md
@.planning/phases/03-data-quality-postgresql-migration/03-02-SUMMARY.md
@.planning/phases/03-data-quality-postgresql-migration/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Schema Migration and Database State</name>
  <files></files>
  <action>
Verify the Prisma schema changes are applied and working correctly.

1. Start Docker stack:
   ```bash
   docker-compose up -d
   ```

2. Wait for services to be healthy:
   ```bash
   docker-compose ps
   # All services should show "healthy" status
   ```

3. Run migration validation:
   ```bash
   cd backend
   DATABASE_URL="postgresql://timetracker:password@localhost:5432/timetracker" \
     npx ts-node scripts/validate-migration.ts
   ```
   Expected: "VALIDATION PASSED"

4. Verify TIMESTAMPTZ columns:
   ```bash
   docker exec time-tracker-db-1 psql -U timetracker -d timetracker -c \
     "SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'TimeEntry' AND column_name IN ('date', 'createdAt');"
   ```
   Expected: Both columns show "timestamp with time zone"

5. Verify UUID generation:
   ```bash
   docker exec time-tracker-db-1 psql -U timetracker -d timetracker -c \
     "SELECT id, source, project FROM \"TimeEntry\" LIMIT 3;"
   ```
   Expected: IDs are UUID format (xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)

If SQLite migration was needed (dev.db existed with data), verify count matches.
  </action>
  <verify>
VALIDATION PASSED message from validation script.
TIMESTAMPTZ type confirmed for date and createdAt columns.
UUID format confirmed for id column.
  </verify>
  <done>Database schema uses TIMESTAMPTZ for timestamps, UUIDs for IDs, migration validation passes</done>
</task>

<task type="auto">
  <name>Task 2: Test Collision Handling and Sync Operations</name>
  <files></files>
  <action>
Test that duplicate entries are handled correctly per CONTEXT.md decisions (fail on collision).

1. Trigger a Tempo sync via API:
   ```bash
   curl -X POST http://localhost/api/sync/tempo \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json"
   ```
   Expected: Success response with count

2. Immediately trigger same sync again:
   ```bash
   curl -X POST http://localhost/api/sync/tempo \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json"
   ```
   Expected: Success (upsert updates existing entries, no collision)

3. Check issue key display in response or database:
   ```bash
   docker exec time-tracker-db-1 psql -U timetracker -d timetracker -c \
     "SELECT id, source, project FROM \"TimeEntry\" WHERE source = 'TEMPO' LIMIT 5;"
   ```
   Expected: project column shows issue keys like "ABC-27" or "ABC-27 - Project Name"

4. Test concurrent sync (simulate race condition):
   Open two terminals and run simultaneously:
   ```bash
   # Terminal 1
   curl -X POST http://localhost/api/sync/tempo?force=true \
     -H "Authorization: Bearer $TOKEN"

   # Terminal 2
   curl -X POST http://localhost/api/sync/tempo?force=true \
     -H "Authorization: Bearer $TOKEN"
   ```
   Expected: Both complete successfully (Prisma upsert handles race conditions)

5. Verify no duplicates created:
   ```bash
   docker exec time-tracker-db-1 psql -U timetracker -d timetracker -c \
     "SELECT source, \"externalId\", COUNT(*) FROM \"TimeEntry\" GROUP BY source, \"externalId\" HAVING COUNT(*) > 1;"
   ```
   Expected: Empty result (no duplicates)
  </action>
  <verify>
Sync operations complete successfully.
Issue keys visible in project column.
No duplicate entries created after concurrent syncs.
  </verify>
  <done>Sync operations work correctly, issue keys display, collision handling prevents duplicates</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 3 functionality:
- PostgreSQL with TIMESTAMPTZ timestamps
- Database-level UUID generation
- Tempo issue key display (ABC-27 format)
- Clickable Jira links (if JIRA_BASE_URL configured)
- Timezone selector in header
- Relative timestamp display for recent entries
  </what-built>
  <how-to-verify>
1. Open http://localhost in browser
2. Log in with admin credentials

3. **Check Timezone Selector:**
   - Look for timezone dropdown in header area
   - Select a different timezone
   - Refresh page - preference should persist

4. **Check Issue Key Display:**
   - Find Tempo entries in the table
   - Project column should show issue keys like "ABC-27" or "ABC-27 - Project Name"
   - If JIRA_BASE_URL is configured: Click an issue key - should open Jira in new tab

5. **Check Timestamps:**
   - If any recent entries exist (< 24 hours), they should show relative time like "vor 2 Stunden"
   - Hover over timestamp to see full date/time in tooltip

6. **Verify Data Integrity:**
   - Check that existing entries display correctly
   - Trigger a sync (Toggl or Tempo) - should complete without errors
   - New entries should appear in the table

7. **Optional: If migrating from SQLite:**
   - Verify entry count matches what was in SQLite
   - Spot-check a few entries for correct data
  </how-to-verify>
  <resume-signal>
Type "approved" if all checks pass, or describe any issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. Docker stack healthy: `docker-compose ps` shows all services healthy
2. Database schema verified: TIMESTAMPTZ columns, UUID ids
3. Migration validation passes: "VALIDATION PASSED"
4. Sync operations work without creating duplicates
5. Frontend displays timezone selector, issue keys, relative timestamps
6. User visual verification confirms UX works correctly
</verification>

<success_criteria>
- Database migration complete and validated
- TIMESTAMPTZ columns preserve timezone information
- UUID generation working at database level
- Concurrent sync operations handle collisions correctly
- Issue keys display in dashboard with clickable Jira links
- Timezone preference persists across sessions
- User confirms all features working via visual verification
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-quality-postgresql-migration/03-04-SUMMARY.md`
</output>
