---
phase: 02-containerization-a-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/frontend/Dockerfile
  - docker/frontend/nginx.conf
  - frontend/.dockerignore
autonomous: true

must_haves:
  truths:
    - "Frontend builds as Docker image without errors"
    - "Nginx serves static files with SPA routing"
    - "Nginx proxies /api and /auth requests to backend"
  artifacts:
    - path: "docker/frontend/Dockerfile"
      provides: "Multi-stage frontend Docker build"
      contains: "FROM nginx:alpine"
    - path: "docker/frontend/nginx.conf"
      provides: "SPA routing and API proxy configuration"
      contains: "try_files $uri $uri/ /index.html"
    - path: "frontend/.dockerignore"
      provides: "Build context exclusions"
      min_lines: 8
  key_links:
    - from: "docker/frontend/nginx.conf"
      to: "backend:3000"
      via: "proxy_pass directive"
      pattern: "proxy_pass http://backend:3000"
---

<objective>
Containerize the frontend service with multi-stage Docker build and Nginx configuration for SPA routing and API proxying.

Purpose: Enable the frontend to run as a production-ready Docker container with Nginx serving static files, handling SPA client-side routing, and proxying API requests to the backend service.

Output: Frontend Dockerfile, Nginx configuration, .dockerignore file
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-containerization-a-deployment/02-CONTEXT.md
@.planning/phases/02-containerization-a-deployment/02-RESEARCH.md

# Key existing files
@frontend/package.json
@frontend/vite.config.ts
@frontend/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create frontend Dockerfile with multi-stage build</name>
  <files>docker/frontend/Dockerfile</files>
  <action>
Create multi-stage Dockerfile for frontend:

**Stage 1 (builder):**
- Base: `node:22-alpine` (Alpine is fine for frontend - no native modules)
- WORKDIR /app
- Copy package*.json, run `npm ci`
- Copy all source files
- Set build-time environment variable for API URL:
  `ARG VITE_API_URL=/api`
  `ENV VITE_API_URL=$VITE_API_URL`
- Run `npm run build` (vite build)

**Stage 2 (serve):**
- Base: `nginx:alpine`
- Copy built files from builder: `COPY --from=builder /app/dist /usr/share/nginx/html`
- Copy nginx config: `COPY nginx.conf /etc/nginx/conf.d/default.conf`
- EXPOSE 80
- CMD: `["nginx", "-g", "daemon off;"]`

Full Dockerfile:
```dockerfile
# Stage 1: Build
FROM node:22-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
ARG VITE_API_URL=/api
ENV VITE_API_URL=$VITE_API_URL
RUN npm run build

# Stage 2: Serve
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```
  </action>
  <verify>
Run `docker build -f docker/frontend/Dockerfile -t time-tracker-frontend ./frontend` - should complete successfully
  </verify>
  <done>Dockerfile exists at docker/frontend/Dockerfile with multi-stage build (node:alpine -> nginx:alpine)</done>
</task>

<task type="auto">
  <name>Task 2: Create Nginx configuration for SPA and API proxy</name>
  <files>docker/frontend/nginx.conf</files>
  <action>
Create Nginx configuration that:
1. Serves static files from /usr/share/nginx/html
2. Handles SPA routing with try_files fallback to index.html
3. Proxies /api/ requests to backend service
4. Proxies /auth/ requests to backend service (auth routes)
5. Proxies /health requests to backend (for debugging)
6. Sets appropriate caching headers for static assets

```nginx
server {
    listen 80;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # SPA routing - fallback to index.html for client-side routes
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Proxy API requests to backend
    location /api/ {
        proxy_pass http://backend:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_header Set-Cookie;
    }

    # Proxy auth requests to backend
    location /auth/ {
        proxy_pass http://backend:3000/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_header Set-Cookie;
    }

    # Proxy health check to backend (useful for debugging)
    location /health {
        proxy_pass http://backend:3000/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Cache static assets aggressively
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

IMPORTANT: The proxy_pass uses `backend` as hostname - this is the Docker Compose service name that will be resolved via Docker's internal DNS.

Include Cookie headers in proxy to ensure auth cookies are forwarded properly.
  </action>
  <verify>
Nginx config syntax check: `docker run --rm -v $(pwd)/docker/frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro nginx:alpine nginx -t`
  </verify>
  <done>Nginx config handles SPA routing, proxies /api/ and /auth/ to backend:3000, caches static assets</done>
</task>

<task type="auto">
  <name>Task 3: Create frontend .dockerignore</name>
  <files>frontend/.dockerignore</files>
  <action>
Create .dockerignore file to exclude unnecessary files from Docker build context:

```
node_modules
npm-debug.log
.git
.gitignore
Dockerfile*
docker-compose*
.dockerignore
dist/
coverage/
*.log
.DS_Store
*.md
.env
.env.*
```

This excludes:
- node_modules (will be installed fresh in container)
- Build artifacts (will be built in container)
- Development files and logs
- Documentation
  </action>
  <verify>
File exists at frontend/.dockerignore with appropriate exclusions
  </verify>
  <done>.dockerignore file excludes node_modules, dist, and development files</done>
</task>

</tasks>

<verification>
1. `docker build -f docker/frontend/Dockerfile -t time-tracker-frontend ./frontend` completes successfully
2. Nginx config passes syntax check: `docker run --rm -v $(pwd)/docker/frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro nginx:alpine nginx -t`
3. `frontend/.dockerignore` contains all specified exclusions
</verification>

<success_criteria>
- Frontend Dockerfile uses multi-stage build (node:alpine for build, nginx:alpine for serve)
- Nginx config serves static files with SPA fallback routing
- Nginx config proxies /api/ and /auth/ to backend:3000
- .dockerignore excludes build artifacts and node_modules
</success_criteria>

<output>
After completion, create `.planning/phases/02-containerization-a-deployment/02-02-SUMMARY.md`
</output>
