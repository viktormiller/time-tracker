---
phase: 04-ux-enhancements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/src/services/pdf-generator.ts
  - backend/src/routes/export.routes.ts
  - backend/src/server.ts
  - docker/backend/Dockerfile
autonomous: true

must_haves:
  truths:
    - "Backend can generate PDF from time entry data"
    - "PDF includes formatted table of entries"
    - "PDF has professional headers and footers"
    - "Docker container supports Puppeteer execution"
  artifacts:
    - path: "backend/src/services/pdf-generator.ts"
      provides: "PDF generation service using Puppeteer"
      exports: ["generatePDF"]
    - path: "backend/src/routes/export.routes.ts"
      provides: "PDF export endpoint"
      exports: ["default"]
  key_links:
    - from: "backend/src/routes/export.routes.ts"
      to: "backend/src/services/pdf-generator.ts"
      via: "function import"
      pattern: "generatePDF\\("
    - from: "backend/src/server.ts"
      to: "backend/src/routes/export.routes.ts"
      via: "route registration"
      pattern: "register.*exportRoutes"
---

<objective>
Implement backend PDF generation service using Puppeteer

Purpose: Enable server-side PDF generation that can render time entry data with proper formatting, headers, and footers. Client-side PDF solutions produce inferior quality.

Output: POST /api/export/pdf endpoint that accepts entry data and returns a PDF buffer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ux-enhancements/04-CONTEXT.md
@.planning/phases/04-ux-enhancements/04-RESEARCH.md

@backend/src/server.ts
@backend/package.json
@docker/backend/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Puppeteer and create PDF generator service</name>
  <files>
    backend/package.json
    backend/src/services/pdf-generator.ts
  </files>
  <action>
    1. Install Puppeteer:
       cd backend && npm install puppeteer

    2. Create backend/src/services/pdf-generator.ts:

       Import puppeteer from 'puppeteer'
       Import { format } from 'date-fns'
       Import { de } from 'date-fns/locale'

       Define TimeEntry interface:
       { date: string, duration: number, project: string, description: string, source: string }

       Define generatePDF function:
       Parameters:
         entries: TimeEntry[]
         dateRange: { from: string; to: string }
         totalHours: number

       Implementation:
       - Launch browser with:
         headless: true
         args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']

       - Create new page

       - Build HTML content string with:
         - DOCTYPE html, html, head with inline CSS
         - CSS for print styling: font-family sans-serif, table borders, alternating row colors
         - Header: "Zeiterfassung Report" with date range
         - Summary section: total hours, entry count
         - Table with columns: Datum, Quelle, Projekt, Beschreibung, Stunden
         - Each entry as table row
         - Footer with generation timestamp

       - Set page content with waitUntil: 'networkidle2'

       - Generate PDF with:
         format: 'A4'
         printBackground: true
         margin: { top: '1cm', right: '1cm', bottom: '1.5cm', left: '1cm' }
         displayHeaderFooter: true
         headerTemplate: '<div style="font-size: 9px; color: #666; width: 100%; text-align: center; padding: 5px;">Zeiterfassung Report</div>'
         footerTemplate: '<div style="font-size: 9px; color: #666; width: 100%; text-align: center; padding: 5px;">Seite <span class="pageNumber"></span> von <span class="totalPages"></span></div>'

       - Close browser in finally block

       - Return PDF buffer

    Helper function for HTML generation:
    - Create generateReportHTML(entries, dateRange, totalHours) that returns complete HTML string
    - Use inline styles for PDF compatibility (no external CSS)
    - Format dates using date-fns with German locale
    - Escape HTML in description/project fields to prevent XSS
  </action>
  <verify>
    cd backend && npm run build succeeds
    No TypeScript errors
  </verify>
  <done>
    Puppeteer installed, PDF generator service created with HTML templating
  </done>
</task>

<task type="auto">
  <name>Task 2: Create export routes and register in server</name>
  <files>
    backend/src/routes/export.routes.ts
    backend/src/server.ts
  </files>
  <action>
    1. Create backend/src/routes/export.routes.ts:

       Import FastifyPluginAsync from 'fastify'
       Import { generatePDF } from '../services/pdf-generator'

       Define request body interface:
       {
         entries: Array<{ date: string, duration: number, project: string, description: string, source: string }>
         dateRange: { from: string, to: string }
         totalHours: number
       }

       Create exportRoutes plugin:
       - POST /export/pdf endpoint
       - Extract entries, dateRange, totalHours from request.body
       - Validate entries array exists and is not empty
       - Call generatePDF with data
       - Set response headers:
         Content-Type: application/pdf
         Content-Disposition: attachment; filename=timetracker-{from}-to-{to}.pdf
       - Return PDF buffer

       Error handling:
       - If entries empty, return 400 with error message
       - If PDF generation fails, log error and return 500

       Export default exportRoutes

    2. Update backend/src/server.ts:

       - Import exportRoutes from './routes/export.routes'

       - Inside the protected routes plugin (line ~46), add:
         protectedRoutes.register(exportRoutes)

       This ensures the export endpoint is protected by authentication.
  </action>
  <verify>
    cd backend && npm run build succeeds
    No TypeScript errors
    Export route registered within protected routes
  </verify>
  <done>
    Export routes created with POST /api/export/pdf endpoint, registered in server
  </done>
</task>

<task type="auto">
  <name>Task 3: Update Docker configuration for Puppeteer</name>
  <files>
    docker/backend/Dockerfile
  </files>
  <action>
    Update docker/backend/Dockerfile to support Puppeteer:

    1. In the production stage (after FROM node:22-slim), update apt-get install:

       Current:
       RUN apt-get update && apt-get install -y openssl curl && rm -rf /var/lib/apt/lists/*

       Change to:
       RUN apt-get update && apt-get install -y \
           openssl \
           curl \
           chromium \
           fonts-liberation \
           libasound2 \
           libatk-bridge2.0-0 \
           libatk1.0-0 \
           libcups2 \
           libdbus-1-3 \
           libdrm2 \
           libgbm1 \
           libnspr4 \
           libnss3 \
           libxcomposite1 \
           libxdamage1 \
           libxfixes3 \
           libxkbcommon0 \
           libxrandr2 \
           xdg-utils \
           && rm -rf /var/lib/apt/lists/*

    2. Add Puppeteer environment variables before USER node:
       ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
       ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

    3. Update pdf-generator.ts to use the system Chromium:
       In puppeteer.launch(), add:
       executablePath: process.env.PUPPETEER_EXECUTABLE_PATH || undefined

    Note: The node:22-slim base already used for bcrypt compatibility is compatible with Puppeteer dependencies.
  </action>
  <verify>
    Dockerfile syntax is valid
    Build check: docker build -t timetracker-backend-test -f docker/backend/Dockerfile backend/ (or just verify syntax)
  </verify>
  <done>
    Docker configuration updated with Chromium dependencies for Puppeteer
  </done>
</task>

</tasks>

<verification>
1. Build check: `cd backend && npm run build` completes without errors
2. Type check: No TypeScript errors in pdf-generator.ts or export.routes.ts
3. Route registration: export routes imported and registered in server.ts
4. Docker: Dockerfile includes Chromium dependencies and environment variables
5. Local test (optional): Start backend, POST to /api/export/pdf with sample data, receive PDF
</verification>

<success_criteria>
- Puppeteer installed in backend dependencies
- PDF generator service accepts entries array and returns PDF buffer
- POST /api/export/pdf endpoint exists and is protected by authentication
- PDF includes: report title, date range, entries table, page numbers
- Dockerfile updated with Chromium and required system libraries
- Environment variables set for Puppeteer to use system Chromium
</success_criteria>

<output>
After completion, create `.planning/phases/04-ux-enhancements/04-03-SUMMARY.md`
</output>
