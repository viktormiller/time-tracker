---
phase: 04-ux-enhancements
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can export filtered entries with chart as PDF"
    - "PDF downloads with meaningful filename"
    - "Loading state shown during PDF generation"
    - "All phase 4 features work together (dark mode, CSV, PDF)"
  artifacts:
    - path: "frontend/src/App.tsx"
      provides: "PDF export button and API call"
      contains: "handleExportPDF"
  key_links:
    - from: "frontend/src/App.tsx"
      to: "/api/export/pdf"
      via: "axios POST request"
      pattern: "axios\\.post.*export/pdf"
---

<objective>
Add PDF export button to frontend and verify all Phase 4 features end-to-end

Purpose: Complete the PDF export feature by adding the frontend button and API integration. Verify dark mode, CSV export, and PDF export all work correctly together.

Output: Working PDF export button, verified complete Phase 4 functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ux-enhancements/04-CONTEXT.md
@.planning/phases/04-ux-enhancements/04-RESEARCH.md

@frontend/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PDF export button and API call</name>
  <files>
    frontend/src/App.tsx
  </files>
  <action>
    1. Add state for PDF export loading (near other state declarations ~line 92):
       const [exportingPdf, setExportingPdf] = useState(false);

    2. Import FileText icon from lucide-react (for PDF button, distinct from Download for CSV)

    3. Add PDF export handler function (after handleExportCSV):

       const handleExportPDF = async () => {
         if (filteredEntries.length === 0) {
           alert('Keine EintrÃ¤ge zum Exportieren vorhanden.');
           return;
         }

         setExportingPdf(true);
         try {
           const response = await axios.post(
             `${API_URL}/export/pdf`,
             {
               entries: filteredEntries.map(e => ({
                 date: e.date,
                 duration: e.duration,
                 project: e.project,
                 description: e.description,
                 source: e.source
               })),
               dateRange: {
                 from: format(dateRange.start, 'yyyy-MM-dd'),
                 to: format(dateRange.end, 'yyyy-MM-dd')
               },
               totalHours: filteredEntries.reduce((sum, e) => sum + e.duration, 0)
             },
             { responseType: 'blob' }
           );

           // Create download link
           const blob = new Blob([response.data], { type: 'application/pdf' });
           const url = window.URL.createObjectURL(blob);
           const link = document.createElement('a');
           link.href = url;
           link.download = `timetracker-${format(dateRange.start, 'yyyy-MM-dd')}-to-${format(dateRange.end, 'yyyy-MM-dd')}.pdf`;
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
           window.URL.revokeObjectURL(url);
         } catch (error) {
           console.error('PDF export failed:', error);
           alert('PDF Export fehlgeschlagen. Bitte versuchen Sie es erneut.');
         } finally {
           setExportingPdf(false);
         }
       };

    4. Add PDF export button in header (after CSV Export button):
       <button
         onClick={handleExportPDF}
         disabled={exportingPdf}
         className="flex items-center gap-2 bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-600 text-white px-4 py-2.5 rounded-lg font-medium transition shadow-sm disabled:opacity-50 text-sm"
       >
         {exportingPdf ? <Loader2 size={16} className="animate-spin" /> : <FileText size={16} />}
         PDF Export
       </button>

    Note: Use red color to distinguish from green CSV button, visual variety in header.
  </action>
  <verify>
    npm run build succeeds
    No TypeScript errors
    PDF export button appears in header
  </verify>
  <done>
    PDF export button added with loading state and blob download handling
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 4 UX Enhancements:
    1. Dark mode toggle (04-01)
    2. CSV export (04-02)
    3. PDF export backend (04-03)
    4. PDF export frontend (04-04 Task 1)
  </what-built>
  <how-to-verify>
    Start the application:
    1. cd /Users/vmiller/projects/time-tracker
    2. docker-compose up --build

    Wait for all services to start, then open http://localhost in browser.

    **Dark Mode Verification:**
    1. Look for sun/moon icon in top-right of header
    2. Click to toggle theme - UI should switch between light and dark
    3. Refresh page - theme should persist
    4. Check that all sections are readable in dark mode:
       - Header, control bar, KPI cards
       - Chart (colors should adjust)
       - Table (alternating rows, hover states)
       - Modals (click edit on an entry)

    **CSV Export Verification:**
    1. Ensure some time entries are visible
    2. Click green "CSV Export" button in header
    3. File should download: timetracker-YYYY-MM-DD-to-YYYY-MM-DD.csv
    4. Open in text editor or Excel - should have German headers and entry data
    5. Create a test: add entry with description starting with "=" - should be escaped in CSV

    **PDF Export Verification:**
    1. Click red "PDF Export" button
    2. Button should show spinner while generating (may take 2-5 seconds)
    3. PDF file should download
    4. Open PDF - should contain:
       - Report title with date range
       - Summary (total hours, entry count)
       - Table of entries
       - Page numbers in footer

    **Edge Cases:**
    1. Filter to show 0 entries - both export buttons should show alert
    2. Try exports in both light and dark mode
  </how-to-verify>
  <resume-signal>Type "approved" if all features work correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Build check: Both frontend and backend build successfully
2. Docker: `docker-compose up --build` starts all services
3. Dark mode: Toggle works, persists, no FOUC, all components styled
4. CSV export: Downloads file with correct filename and content
5. PDF export: Downloads file with professional formatting
6. Error states: Empty filter shows alerts, not broken exports
</verification>

<success_criteria>
Phase 4 complete when:
- User can toggle between light and dark themes (persists across sessions)
- User can export filtered entries as CSV file
- User can export filtered entries as PDF file
- All components readable in both light and dark modes
- Export buttons show appropriate loading/disabled states
- Error handling for edge cases (empty data, generation failures)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ux-enhancements/04-04-SUMMARY.md`
</output>
