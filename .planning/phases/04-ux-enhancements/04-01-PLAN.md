---
phase: 04-ux-enhancements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/index.html
  - frontend/tailwind.config.js
  - frontend/src/lib/theme.ts
  - frontend/src/hooks/useTheme.tsx
  - frontend/src/components/ThemeToggle.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between light and dark themes via icon button"
    - "Theme preference persists across browser sessions"
    - "No flash of wrong theme on page load"
    - "All UI components readable in both light and dark modes"
  artifacts:
    - path: "frontend/src/lib/theme.ts"
      provides: "Theme persistence utilities"
      exports: ["getTheme", "setTheme"]
    - path: "frontend/src/hooks/useTheme.tsx"
      provides: "React hook for theme state management"
      exports: ["useTheme"]
    - path: "frontend/src/components/ThemeToggle.tsx"
      provides: "Sun/Moon toggle button component"
      exports: ["ThemeToggle"]
  key_links:
    - from: "frontend/index.html"
      to: "localStorage"
      via: "inline script in head"
      pattern: "localStorage\\.getItem.*theme"
    - from: "frontend/src/hooks/useTheme.tsx"
      to: "document.documentElement"
      via: "classList.toggle('dark')"
      pattern: "classList\\.toggle.*dark"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/components/ThemeToggle.tsx"
      via: "component import and render"
      pattern: "<ThemeToggle"
---

<objective>
Implement dark mode toggle with Tailwind CSS class-based theming

Purpose: Allow users to switch between light and dark themes for comfortable viewing in different lighting conditions. Theme preference persists across sessions.

Output: Working theme toggle in header, all components styled for both modes, no flash of wrong theme on load.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ux-enhancements/04-CONTEXT.md
@.planning/phases/04-ux-enhancements/04-RESEARCH.md

@frontend/src/App.tsx
@frontend/src/lib/timezone.ts
@frontend/tailwind.config.js
@frontend/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme infrastructure and FOUC prevention</name>
  <files>
    frontend/index.html
    frontend/tailwind.config.js
    frontend/src/lib/theme.ts
    frontend/src/hooks/useTheme.tsx
  </files>
  <action>
    1. Update tailwind.config.js:
       - Add `darkMode: 'selector'` (Tailwind v3.4+ syntax)
       - Keep existing content paths

    2. Add FOUC prevention script to frontend/index.html:
       - Insert inline script in `<head>` BEFORE any stylesheets
       - Script checks localStorage for 'theme' key
       - If 'dark' or (no preference AND prefers-color-scheme: dark), add 'dark' class to documentElement
       - Must execute synchronously before first paint

    3. Create frontend/src/lib/theme.ts (follow timezone.ts pattern):
       - THEME_KEY constant = 'user_theme_preference'
       - getTheme(): returns stored preference or 'system' if none
       - setTheme(theme: 'light' | 'dark' | 'system'): saves to localStorage, 'system' removes key
       - getEffectiveTheme(): returns actual 'light' or 'dark' based on preference + system

    4. Create frontend/src/hooks/useTheme.tsx:
       - useState initialized from getTheme()
       - useEffect that:
         - Reads effective theme (considering 'system' option)
         - Toggles 'dark' class on document.documentElement
         - Persists via setTheme()
       - Listen to prefers-color-scheme changes when theme is 'system'
       - Return { theme, setTheme, effectiveTheme }
  </action>
  <verify>
    - tailwind.config.js contains `darkMode: 'selector'`
    - index.html has inline script in head before stylesheet
    - npm run build succeeds
  </verify>
  <done>
    Theme infrastructure ready: config, FOUC prevention, persistence utilities, React hook
  </done>
</task>

<task type="auto">
  <name>Task 2: ThemeToggle component and header integration</name>
  <files>
    frontend/src/components/ThemeToggle.tsx
    frontend/src/App.tsx
  </files>
  <action>
    1. Create frontend/src/components/ThemeToggle.tsx:
       - Import Sun, Moon from lucide-react
       - Import useTheme hook
       - Button displays Sun icon in dark mode, Moon icon in light mode
       - onClick toggles between 'light' and 'dark' (explicit, not 'system')
       - Tailwind classes: p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors
       - Include aria-label for accessibility

    2. Update frontend/src/App.tsx header section (around line 346-398):
       - Import ThemeToggle component
       - Add ThemeToggle in header, positioned in top-right area (before logout button)
       - Place it after timezone selector, before the logout separator
  </action>
  <verify>
    npm run build succeeds
    TypeScript has no type errors
  </verify>
  <done>
    ThemeToggle component created and integrated into header
  </done>
</task>

<task type="auto">
  <name>Task 3: Dark mode styles for all components</name>
  <files>
    frontend/src/App.tsx
  </files>
  <action>
    Update App.tsx with dark: variant classes for all components. Key areas:

    1. Root container (line ~331):
       - Change bg-gray-50 to bg-gray-50 dark:bg-gray-900
       - Change text-gray-800 to text-gray-800 dark:text-gray-100

    2. Header (line ~346):
       - bg-white dark:bg-gray-800
       - border-gray-100 dark:border-gray-700
       - text-gray-900 dark:text-white for title

    3. Control bar (line ~401):
       - bg-white dark:bg-gray-800
       - border-gray-100 dark:border-gray-700
       - Dropdowns: bg-gray-50 dark:bg-gray-700, text-gray-700 dark:text-gray-200

    4. KPI Cards (Card component ~678):
       - bg-white dark:bg-gray-800
       - border-gray-100 dark:border-gray-700
       - text-gray-500 dark:text-gray-400 for labels

    5. Chart container (line ~443):
       - bg-white dark:bg-gray-800
       - Update chart colors: see research for dark mode palette
       - Pass isDarkMode prop to chart configuration
       - CartesianGrid stroke: #f3f4f6 light, #404040 dark
       - XAxis/YAxis tick fill: #9ca3af light, #d1d5db dark

    6. Table container (line ~479):
       - bg-white dark:bg-gray-800
       - thead bg-gray-50 dark:bg-gray-700
       - tbody divide-gray-100 dark:divide-gray-700
       - hover:bg-gray-50 dark:hover:bg-gray-700
       - tfoot bg-gray-50 dark:bg-gray-700

    7. Modals (EditModal, SyncModal):
       - bg-white dark:bg-gray-800
       - border-gray-100 dark:border-gray-700
       - Input/textarea styling for dark mode

    8. TogglDateRangePicker popup (line ~591):
       - bg-white dark:bg-gray-800
       - Preset buttons styling for dark mode

    Soft dark palette: Use ~#1a1a1a for main background via dark:bg-gray-900, ~#2d2d2d for cards via dark:bg-gray-800
  </action>
  <verify>
    npm run build succeeds
    No TypeScript errors
    Visual inspection: Toggle theme and verify all major sections have dark styling
  </verify>
  <done>
    All components have dark: variants, chart colors adjust for dark mode, UI is readable in both themes
  </done>
</task>

</tasks>

<verification>
1. Build check: `cd frontend && npm run build` completes without errors
2. FOUC prevention: Set theme to 'dark' in localStorage, hard refresh - no white flash
3. Toggle functionality: Click toggle, theme switches immediately
4. Persistence: Refresh page, theme preference retained
5. System preference: Clear localStorage, respect system dark mode setting
6. Chart readability: View chart in dark mode, bars and labels visible
7. Table readability: View entries table in dark mode, text and borders visible
</verification>

<success_criteria>
- Theme toggle appears in header (sun/moon icon)
- Clicking toggle switches between light and dark themes instantly
- Theme persists across page refreshes
- No flash of wrong theme on initial load
- All components (header, cards, chart, table, modals) are readable in both modes
- Chart visualization adapts colors for dark background
</success_criteria>

<output>
After completion, create `.planning/phases/04-ux-enhancements/04-01-SUMMARY.md`
</output>
