---
phase: 04-ux-enhancements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/src/lib/csv-export.ts
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can export filtered entries as CSV file"
    - "CSV file downloads with meaningful filename including date range"
    - "CSV data is sanitized against formula injection"
    - "Export includes all relevant fields (date, hours, source, description, project)"
  artifacts:
    - path: "frontend/src/lib/csv-export.ts"
      provides: "CSV generation with sanitization"
      exports: ["exportToCSV"]
  key_links:
    - from: "frontend/src/App.tsx"
      to: "frontend/src/lib/csv-export.ts"
      via: "function import and call"
      pattern: "exportToCSV\\("
    - from: "frontend/src/lib/csv-export.ts"
      to: "export-to-csv"
      via: "library import"
      pattern: "from 'export-to-csv'"
---

<objective>
Implement CSV export for filtered time entries

Purpose: Allow users to export their filtered time entry data as CSV files for use in spreadsheets, reports, or other tools.

Output: Export CSV button in header that downloads currently filtered entries with proper sanitization.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ux-enhancements/04-CONTEXT.md
@.planning/phases/04-ux-enhancements/04-RESEARCH.md

@frontend/src/App.tsx
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install export-to-csv and create export utility</name>
  <files>
    frontend/package.json
    frontend/src/lib/csv-export.ts
  </files>
  <action>
    1. Install export-to-csv library:
       cd frontend && npm install export-to-csv

    2. Create frontend/src/lib/csv-export.ts:

       - Import { mkConfig, generateCsv, download } from 'export-to-csv'
       - Import { format } from 'date-fns'

       - Define TimeEntry interface (or import from shared types if available):
         { id: string, date: string, duration: number, project: string, description: string, source: string }

       - Create sanitizeCsvField(value: string | number): string function
         - Convert to string
         - If starts with =, +, -, @, prefix with single quote (') to prevent formula injection
         - Return sanitized value

       - Create exportToCSV function:
         Parameters: entries: TimeEntry[], dateRange: { start: Date; end: Date }

         Implementation:
         - Create csvConfig using mkConfig:
           - filename: `timetracker-${format(dateRange.start, 'yyyy-MM-dd')}-to-${format(dateRange.end, 'yyyy-MM-dd')}`
           - useKeysAsHeaders: false
           - columnHeaders: ['Datum', 'Stunden', 'Quelle', 'Beschreibung', 'Projekt'] (German to match UI)

         - Map entries to sanitized row objects:
           - Datum: sanitizeCsvField(format(parseISO(entry.date), 'yyyy-MM-dd HH:mm'))
           - Stunden: sanitizeCsvField(entry.duration.toFixed(2))
           - Quelle: sanitizeCsvField(entry.source)
           - Beschreibung: sanitizeCsvField(entry.description)
           - Projekt: sanitizeCsvField(entry.project)

         - Generate CSV with generateCsv(csvConfig)(sanitizedData)
         - Trigger download with download(csvConfig)(csv)
  </action>
  <verify>
    npm run build succeeds
    No TypeScript errors in csv-export.ts
  </verify>
  <done>
    export-to-csv installed, CSV export utility created with sanitization
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Export CSV button to header</name>
  <files>
    frontend/src/App.tsx
  </files>
  <action>
    1. Import at top of App.tsx:
       - Import { exportToCSV } from './lib/csv-export'
       - Import Download icon from lucide-react (already imported icons there)

    2. Add export handler function in AppContent component (near line ~320, after handleSort):

       const handleExportCSV = () => {
         if (filteredEntries.length === 0) {
           alert('Keine Einträge zum Exportieren vorhanden.');
           return;
         }
         exportToCSV(filteredEntries, dateRange);
       };

    3. Add Export CSV button in header (around line ~390, near the CSV Import button):
       - Position: After the refresh button, before the CSV Import button
       - Button style: Similar to existing buttons but with Download icon
       - Classes: flex items-center gap-2 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition shadow-sm text-sm
       - Include dark mode variants: dark:bg-green-700 dark:hover:bg-green-600
       - Icon: <Download size={16} />
       - Label: "CSV Export"
       - onClick: handleExportCSV

    Button JSX:
    <button
      onClick={handleExportCSV}
      className="flex items-center gap-2 bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-600 text-white px-4 py-2.5 rounded-lg font-medium transition shadow-sm text-sm"
    >
      <Download size={16} />
      CSV Export
    </button>
  </action>
  <verify>
    npm run build succeeds
    No TypeScript errors
  </verify>
  <done>
    Export CSV button integrated into header, triggers download of filtered entries
  </done>
</task>

</tasks>

<verification>
1. Build check: `cd frontend && npm run build` completes without errors
2. Button visible: Export CSV button appears in header with download icon
3. Empty state: With no entries, clicking shows "Keine Einträge" alert
4. Download works: With entries, clicking downloads CSV file
5. Filename correct: Downloaded file named timetracker-YYYY-MM-DD-to-YYYY-MM-DD.csv
6. Content correct: CSV contains headers and filtered entry data
7. Formula injection: Entry with description starting with "=" shows as "'=" in CSV
</verification>

<success_criteria>
- Export CSV button visible in header with green styling
- Clicking button downloads CSV file of currently filtered entries
- CSV filename includes current date range
- CSV has proper headers (Datum, Stunden, Quelle, Beschreibung, Projekt)
- Data is properly escaped (special characters, formula prefixes)
- Empty filter shows appropriate message instead of empty download
</success_criteria>

<output>
After completion, create `.planning/phases/04-ux-enhancements/04-02-SUMMARY.md`
</output>
