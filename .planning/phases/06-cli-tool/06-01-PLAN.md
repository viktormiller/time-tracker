---
phase: 06-cli-tool
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/summary.routes.ts
  - backend/src/server.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/entries/summary/today returns today's total hours and breakdown by source"
    - "GET /api/entries/summary/week returns weekly totals with daily and source breakdowns"
    - "POST /api/sync triggers sync from all configured providers and returns combined results"
  artifacts:
    - path: "backend/src/routes/summary.routes.ts"
      provides: "Summary endpoints (today, week) and unified sync"
      exports: ["default (Fastify plugin)"]
  key_links:
    - from: "backend/src/routes/summary.routes.ts"
      to: "prisma.timeEntry"
      via: "aggregation queries"
      pattern: "prisma\\.timeEntry\\.(findMany|groupBy)"
    - from: "backend/src/routes/summary.routes.ts"
      to: "ProviderFactory"
      via: "unified sync"
      pattern: "ProviderFactory\\.getAllProviders"
    - from: "backend/src/server.ts"
      to: "backend/src/routes/summary.routes.ts"
      via: "plugin registration"
      pattern: "register\\(summaryRoutes\\)"
---

<objective>
Create backend API endpoints required by the CLI tool for viewing time summaries and triggering sync operations.

Purpose: The CLI needs dedicated summary endpoints that aggregate time entries. The existing `/stats` endpoint returns raw entries without aggregation, which would require client-side processing. Creating proper summary endpoints enables thin CLI clients.

Output: Three new API endpoints registered in the backend that return aggregated time data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-tool/06-RESEARCH.md

@backend/src/server.ts
@backend/src/providers/provider.factory.ts
@backend/src/providers/provider.interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create summary routes module</name>
  <files>backend/src/routes/summary.routes.ts</files>
  <action>
Create a new Fastify plugin file that exports three endpoints:

1. `GET /api/entries/summary/today`:
   - Query timeEntry where date is today (UTC day boundaries)
   - Return: `{ date: "YYYY-MM-DD", totalHours: number, bySource: [{ name: string, hours: number }] }`
   - Group by source and sum durations
   - Handle empty results gracefully (return 0 hours)

2. `GET /api/entries/summary/week`:
   - Query timeEntry where date is within current week (Monday 00:00 to Sunday 23:59 UTC)
   - Use date-fns `startOfWeek` and `endOfWeek` with `{ weekStartsOn: 1 }` for Monday start
   - Return: `{ startDate: "YYYY-MM-DD", endDate: "YYYY-MM-DD", totalHours: number, byDay: [{ date: "YYYY-MM-DD", hours: number }], bySource: [{ name: string, hours: number }] }`
   - byDay should have entries for all 7 days even if hours is 0

3. `POST /api/sync`:
   - Use ProviderFactory.getAllProviders() to get all configured providers
   - Call sync() on each provider concurrently with Promise.all
   - Aggregate results: `{ newEntries: number, updated: number, errors: number, providers: [{ name: string, status: "success"|"error", entries: number, message?: string }] }`
   - Catch individual provider errors - don't let one failure stop others

Use date-fns for date calculations (already installed in backend).
Follow existing route patterns from auth.routes.ts and export.routes.ts.
  </action>
  <verify>
TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
File exists with three endpoint handlers using Prisma aggregation and ProviderFactory
  </done>
</task>

<task type="auto">
  <name>Task 2: Register summary routes and test endpoints</name>
  <files>backend/src/server.ts</files>
  <action>
1. Import summaryRoutes at top of server.ts:
   `import summaryRoutes from './routes/summary.routes';`

2. Register inside the protected routes plugin (after exportRoutes):
   `protectedRoutes.register(summaryRoutes);`

3. Test all three endpoints with curl (backend must be running):

Today summary:
```bash
# Get auth token first
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"YOUR_PASSWORD"}' | jq -r '.accessToken')

# Test today endpoint
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/entries/summary/today
```

Week summary:
```bash
curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/entries/summary/week
```

Unified sync:
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/sync
```

All three should return 200 with proper JSON structure.
  </action>
  <verify>
Docker stack running: `docker compose ps` shows healthy services
All endpoints return 200: curl commands above succeed with expected JSON structure
  </verify>
  <done>
- GET /api/entries/summary/today returns `{ date, totalHours, bySource }`
- GET /api/entries/summary/week returns `{ startDate, endDate, totalHours, byDay, bySource }`
- POST /api/sync returns `{ newEntries, updated, errors, providers }`
  </done>
</task>

</tasks>

<verification>
All verification with running backend:

1. Today summary returns aggregated data:
```bash
curl -s -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/entries/summary/today | jq '.totalHours'
```
Should return a number (can be 0 if no entries today)

2. Week summary has 7 days in byDay array:
```bash
curl -s -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/entries/summary/week | jq '.byDay | length'
```
Should return 7

3. Sync endpoint triggers all providers:
```bash
curl -s -X POST -H "Authorization: Bearer $TOKEN" http://localhost:3000/api/sync | jq '.providers | length'
```
Should return 2 (Toggl and Tempo)
</verification>

<success_criteria>
- [ ] summary.routes.ts exists with three endpoint handlers
- [ ] Endpoints registered in server.ts under protected routes
- [ ] GET /api/entries/summary/today returns today's hours aggregated by source
- [ ] GET /api/entries/summary/week returns weekly breakdown by day and source
- [ ] POST /api/sync triggers all providers and returns combined results
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-tool/06-01-SUMMARY.md`
</output>
