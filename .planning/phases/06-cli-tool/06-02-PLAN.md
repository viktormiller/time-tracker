---
phase: 06-cli-tool
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/routes/auth.routes.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/auth/cli-login returns both accessToken AND refreshToken in response body"
    - "CLI clients can authenticate without browser cookies"
    - "Web login flow remains unchanged (refresh token in HttpOnly cookie)"
  artifacts:
    - path: "backend/src/routes/auth.routes.ts"
      provides: "CLI-specific login endpoint"
      contains: "/api/auth/cli-login"
  key_links:
    - from: "CLI client"
      to: "/api/auth/cli-login"
      via: "POST request with credentials"
      pattern: "POST.*cli-login"
    - from: "CLI client"
      to: "/api/auth/cli-refresh"
      via: "POST request with refresh token in body"
      pattern: "POST.*cli-refresh"
---

<objective>
Add CLI-specific authentication endpoints that return tokens in the response body instead of HttpOnly cookies.

Purpose: The existing auth flow stores the refresh token in an HttpOnly cookie, which is secure for browsers but inaccessible to CLI clients. CLI needs to receive the refresh token in the response body to store it locally. Creating dedicated CLI endpoints keeps web security intact while enabling CLI authentication.

Output: Two new endpoints `/api/auth/cli-login` and `/api/auth/cli-refresh` that return tokens in the response body.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-tool/06-RESEARCH.md

@backend/src/routes/auth.routes.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI login endpoint</name>
  <files>backend/src/routes/auth.routes.ts</files>
  <action>
Add a new endpoint `/api/auth/cli-login` in auth.routes.ts, placed after the existing `/api/auth/login` endpoint.

The endpoint should:
1. Accept same body as regular login: `{ username: string, password: string }`
2. Apply same rate limiting as regular login (5 requests per 15 minutes)
3. Perform same credential validation (check username matches ADMIN_USER, verify password with bcrypt)
4. Generate same tokens (15-minute access token, 30-day refresh token)
5. **Key difference:** Return BOTH tokens in the response body instead of setting cookie:

Response format:
```json
{
  "accessToken": "eyJ...",
  "refreshToken": "eyJ...",
  "expiresIn": 900
}
```

Do NOT set any cookies in this endpoint. Do NOT modify the existing `/api/auth/login` endpoint.

Implementation notes:
- Reuse the same credential validation logic (can extract to helper function if clean)
- Same JWT signing with same expiration times
- No session manipulation needed for CLI
  </action>
  <verify>
TypeScript compiles: `cd backend && npx tsc --noEmit`
  </verify>
  <done>
POST /api/auth/cli-login endpoint exists and returns both tokens in body
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CLI refresh endpoint and test both</name>
  <files>backend/src/routes/auth.routes.ts</files>
  <action>
1. Add a new endpoint `/api/auth/cli-refresh` after the cli-login endpoint.

The endpoint should:
- Accept body: `{ refreshToken: string }` (token passed in body, not cookie)
- Verify the refresh token using fastify.jwt.verify()
- Validate token type is 'refresh'
- Generate new access token and new refresh token (rotation)
- Return both in response body:
```json
{
  "accessToken": "eyJ...",
  "refreshToken": "eyJ...",
  "expiresIn": 900
}
```

2. Test both CLI endpoints with curl:

CLI Login:
```bash
curl -X POST http://localhost:3000/api/auth/cli-login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"YOUR_PASSWORD"}'
```
Should return JSON with accessToken AND refreshToken fields.

CLI Refresh:
```bash
# Using refresh token from previous response
curl -X POST http://localhost:3000/api/auth/cli-refresh \
  -H "Content-Type: application/json" \
  -d '{"refreshToken":"eyJ..."}'
```
Should return new tokens.

3. Verify original endpoints still work unchanged:
```bash
# Regular login should still set cookie (check headers)
curl -v -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"YOUR_PASSWORD"}' 2>&1 | grep -i set-cookie
```
Should show Set-Cookie header with refreshToken.
  </action>
  <verify>
- CLI login returns both tokens in body (no Set-Cookie header)
- CLI refresh accepts token in body and returns new tokens
- Original login still sets HttpOnly cookie
  </verify>
  <done>
- POST /api/auth/cli-login returns `{ accessToken, refreshToken, expiresIn }`
- POST /api/auth/cli-refresh accepts `{ refreshToken }` and returns new tokens
- Original /api/auth/login behavior unchanged
  </done>
</task>

</tasks>

<verification>
Test complete CLI auth flow:

1. CLI login returns both tokens:
```bash
RESPONSE=$(curl -s -X POST http://localhost:3000/api/auth/cli-login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"YOUR_PASSWORD"}')
echo $RESPONSE | jq 'has("accessToken") and has("refreshToken")'
# Should output: true
```

2. CLI refresh works with body token:
```bash
REFRESH_TOKEN=$(echo $RESPONSE | jq -r '.refreshToken')
curl -s -X POST http://localhost:3000/api/auth/cli-refresh \
  -H "Content-Type: application/json" \
  -d "{\"refreshToken\":\"$REFRESH_TOKEN\"}" | jq 'has("accessToken")'
# Should output: true
```

3. Original login still uses cookies (inspect response headers):
```bash
curl -si -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"YOUR_PASSWORD"}' | grep -c "Set-Cookie"
# Should output: 1 (cookie is set)
```
</verification>

<success_criteria>
- [ ] POST /api/auth/cli-login exists and returns both tokens in body
- [ ] POST /api/auth/cli-refresh exists and accepts refresh token in body
- [ ] CLI endpoints do NOT set cookies
- [ ] Original /api/auth/login still sets HttpOnly cookie (unchanged)
- [ ] Original /api/auth/refresh still reads from cookie (unchanged)
- [ ] Rate limiting applies to CLI login (5 req/15min)
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-tool/06-02-SUMMARY.md`
</output>
